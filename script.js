const yoKaiList = [
{ name: "Tentelento", img: "tentelento.png" },
{ name: "Tentemacho", img: "tentemacho.png" },
{ name: "Tenterila", img: "tenterila.png" },
{ name: "Nihablar", img: "nihablar.png" },
{ name: "Impás", img: "impas.png" },
{ name: "Murallín", img: "murallin.png" },
{ name: "Lorigón", img: "lorigon.png" },
{ name: "Inquielifante", img: "inquielifante.png" },
{ name: "Perselefante", img: "perselefante.png" },
{ name: "Globqueo", img: "globqueo.png" },
{ name: "Globtundente", img: "globtundente.png" },
{ name: "Montaña Loca", img: "montaña_loca.png" },
{ name: "Lord Lava", img: "lord_lava.png" },
{ name: "Rebelcebú", img: "rebelcebu.png" },
{ name: "Caporrista", img: "caporrista.png" },
{ name: "Hermanión", img: "hermanion.png" },
{ name: "Pegarabajo", img: "pegarabajo.png" },
{ name: "Enormarabajo", img: "enormarabajo.png" },
{ name: "Cuernarabajo", img: "cuernarabajo.png" },
{ name: "Castelius III", img: "castelius_III.png" },
{ name: "Castelius II", img: "castelius_II.png" },
{ name: "Castelius I", img: "Castelius_I.png" },
{ name: "Maxicastelius", img: "Maxicastelius.png" },
{ name: "Robonyan", img: "robonyan.png" },
{ name: "Aureonyan", img: "aureonyan.png" },
{ name: "Pom", img: "pom.png" },
{ name: "Flus", img: "flus.png" },
{ name: "Dorantúo", img: "dorantuo.png" },
    { name: "Aterracota", img: "Aterracota.png" },
    { name: "Quierodeso", img: "Quierodeso.png" },
    { name: "Gambulloso", img: "Gambulloso.png" },
    { name: "Indiligencio", img: "Indiligencio.png" },
    { name: "Tanquivocado", img: "Tanquivocado.png" },
    { name: "Mimoniquí", img: "Mimoniqui.png" },
    { name: "Mamuguanto", img: "Mamuguanto.png" },
    { name: "Rayael", img: "Rayael.png" },
    { name: "Cazarayos", img: "Cazarrayos.png" },
    { name: "Zudado", img: "Zudado.png" },
    { name: "Eleganfibio", img: "Eleganfibio.png" },
    { name: "Frikigarto", img: "Frikigarto.png" },
    { name: "Robonyan 2.0", img: "Robonyan_2.0.png" },
    { name: "Sumodón", img: "Sumodon.png" },
    { name: "Supersumodón", img: "Supersumodon.png" },
    { name: "Desinverest", img: "Desinverest.png" },
    { name: "Inverestupción", img: "Inverestupcion.png" },
    { name: "Gargantúo", img: "Gargantuo_A.png" },
    { name: "Cazamentires", img: "Cazamentires_A.png" },
    { name: "Demoniorco", img: "Demoniorco_A.png" },
  { "name": "Perronyan", "img": "Perronyan.png" },
  { "name": "Kintaronyan", "img": "Kintaronyan.png" },
  { "name": "Kabukio", "img": "Kabukio_A.png" },
  { "name": "Prudencio", "img": "Prudencio.png" },
  { "name": "Explotacota", "img": "Explotacota.png" },
  { "name": "Grafilcebú", "img": "Grafilcebu.png" },
  { "name": "Chocovaca", "img": "Chocovaca.png" },
  { "name": "Vacaloca", "img": "Vacaloca.png" },
  { "name": "Fracalavero", "img": "Fracalavero.png" },
  { "name": "Calabilidoso", "img": "Calabilidoso.png" },
  { "name": "Máster Chof", "img": "Master_Chof.png" },
  { "name": "Monte Merario", "img": "Monte_Merario.png" },
  { "name": "Calmarinero", "img": "Calmarinero.png" },
  { "name": "Almirante Admirable", "img": "Almirante_Admirable.png" },
  { "name": "Peter Punki", "img": "Peter_Punki.png" },
  { "name": "Pantuflo", "img": "Pantuflo.png" },
  { "name": "Reahucio", "img": "Reahucio.png" },
  { "name": "Radiopatio", "img": "Radiopatio.png" },
  { "name": "Filete II", "img": "Filete_II.png" },
  { "name": "Showbonyan", "img": "Showbonyan.png" },
  { "name": "Tiburón Tiburcio", "img": "Tiburon_Tiburcio.png" },
  { "name": "Tiburón Jaquetón", "img": "Tiburon_Jaqueton.png" },
  { "name": "Capitán Nublo", "img": "Capitan_Nublo.png" },
  { "name": "Originyan", "img": "originyan.png" },
  { "name": "Daikokuten", "img": "Daikokuten.png" },
  { "name": "Platinum", "img": "Platinum.png" },
  { "name": "Terminyanator", "img": "Terminyanator.png" },
  { "name": "Frauduralla", "img": "Frauduralla.png" },
  { "name": "Insaciablo", "img": "Insaciablo.png" },
  { "name": "Penancio", "img": "Penancio.png" },
  { "name": "Venoctobot", "img": "Venoctobot.png" },
  { "name": "Demoniorco Lu Bu", "img": "Demoniorco_Lu_Bu.png" },
  { "name": "Kyubot", "img": "Kyubot.png" },
  { "name": "Robonyan Definitivo", "img": "Robonyan_Definitivo.png" },
  { "name": "Rey Palmiro", "img": "Rey_Palmiro.png" },
  { "name": "Masculloso", "img": "Masculloso.png" },
  { "name": "Vociferio", "img": "Vociferio.png" },
    { name: "Chousensha", img: "Chosensha.png" },
    { name: "Monomaneking", aliases: ["Monomaneking", "Mimiking"], img: "Monomaneking.png" },
    { name: "Morigami Rex", img: "Morigami_Rex.png" },
    { name: "Zappadokia", img: "Zappadokia.png" },
    { name: "Gowin", img: "Gowin.png" }
];

let score = 0; 
let gameEnded = false; // Evita cambios una vez terminado el juego
const unlockedYoKai = new Set(); // Registro de Yo-kai desbloqueados por índice

// Normalizar la entrada del usuario (sin tildes y en minúsculas)
function normalizeString(str) {
    return str.normalize("NFD").replace(/[̀-\u036f]/g, "").toLowerCase();
}

// Crear el objeto de audio una sola vez
let getSound = new Audio("get.mp3");

// Reproducir sonido cuando se desbloquea un Yo-kai (sin solapamiento)
function playGetSound() {
    if (!getSound.paused) {
        getSound.pause(); // Detener el sonido actual si ya está reproduciéndose
        getSound.currentTime = 0; // Reiniciar el sonido al principio
    }
    getSound.play(); // Reproducir el sonido
}

// Actualizar la puntuación en formato (adivinados / totales)
function updateScoreDisplay() {
    const scoreDisplay = document.getElementById("score");
    scoreDisplay.textContent = `${score}/${yoKaiList.length}`;
}

// Verificar la respuesta del usuario
function checkAnswer() {
    if (gameEnded) return; // Si el juego ha terminado, no hacer nada

    const userAnswer = normalizeString(document.getElementById("answer-input").value.trim());

    let correctGuess = false; // Bandera para reproducir el sonido solo si hay aciertos

    yoKaiList.forEach((yoKai, index) => {
        // Normaliza todos los nombres asociados al Yo-kai
        const normalizedNames = [yoKai.name, ...(yoKai.aliases || [])].map(name => normalizeString(name));

        // Si la respuesta coincide con alguno de los nombres y no ha sido desbloqueado
        if (normalizedNames.includes(userAnswer) && !unlockedYoKai.has(index)) {
            const yoKaiImg = document.getElementById(`yo-kai${index + 1}`);
            if (yoKaiImg && yoKaiImg.src.includes("no-kai.png")) {
                yoKaiImg.src = yoKai.img; // Actualiza la imagen

                // Añadir clase para animación
                yoKaiImg.classList.add("yokai-unlocked");
                yoKaiImg.addEventListener("animationend", () => {
                    yoKaiImg.classList.remove("yokai-unlocked"); // Quitar clase tras animación
                });

                unlockedYoKai.add(index); // Marcar el Yo-kai como desbloqueado
                score++;
                correctGuess = true; // Se encontró un acierto
            }
        }
    });

    if (correctGuess) {
        playGetSound(); // Reproducir sonido solo si hubo un acierto
        updateScoreDisplay(); // Actualizar puntuación
        document.getElementById("answer-input").value = ""; // Borra la respuesta después de un acierto
    }

    checkGameEnd(); // Verifica si el juego ha terminado
}

// Verificar si el juego ha terminado (cuando se han adivinado todos los Yo-kai)
function checkGameEnd() {
    if (score === yoKaiList.length) {
        gameEnded = true;
        stopTimer(); // Detener el temporizador
        showCongratsImage(); // Mostrar imagen de "¡Felicidades!"
    }
}

function showCongratsImage() {

    // Detener temporizador
    stopTimer();

    // Obtener tiempo final mostrado
    const tiempoTotal = document.getElementById("time").textContent;

    // Sonido de victoria
    const victorySound = new Audio("congrats.mp3");
    victorySound.volume = 0.8;
    victorySound.play().catch(() => {});

    // Panel lateral
    const finalPanel = document.createElement("div");
    finalPanel.style.position = "fixed";
    finalPanel.style.top = "0";
    finalPanel.style.right = "-350px";
    finalPanel.style.width = "320px";
    finalPanel.style.height = "100%";
    finalPanel.style.backgroundColor = "#0b2a4a";
    finalPanel.style.color = "white";
    finalPanel.style.padding = "20px";
    finalPanel.style.boxSizing = "border-box";
    finalPanel.style.zIndex = "1000";
    finalPanel.style.fontFamily = "Arial, sans-serif";
    finalPanel.style.display = "flex";
    finalPanel.style.flexDirection = "column";
    finalPanel.style.transition = "right 0.6s ease";

    // Botón cerrar
    const closeBtn = document.createElement("div");
    closeBtn.textContent = "✖";
    closeBtn.style.position = "absolute";
    closeBtn.style.top = "15px";
    closeBtn.style.right = "15px";
    closeBtn.style.cursor = "pointer";
    closeBtn.style.fontSize = "18px";

    closeBtn.addEventListener("click", () => {
        finalPanel.style.right = "-350px";
        setTimeout(() => finalPanel.remove(), 600);
    });

    // Título
    const title = document.createElement("h2");
    title.textContent = `¡Enhorabuena! Has adivinado todos los Yo-kai en ${tiempoTotal}`;
    title.style.marginTop = "40px";
    title.style.marginBottom = "30px";
    title.style.fontSize = "22px";

    // Texto Twitter
    const followText = document.createElement("p");
    followText.innerHTML = `
        Si te ha gustado, ¿por qué no seguirme en twitter?: 
        <a href="https://x.com/salty_baconV2" target="_blank" style="color:#4fc3ff; text-decoration:none;">
        @Salty_BaconV2
        </a>
    `;
    followText.style.fontSize = "16px";
    followText.style.marginTop = "auto";

    // Montaje
    finalPanel.appendChild(closeBtn);
    finalPanel.appendChild(title);
    finalPanel.appendChild(followText);
    document.body.appendChild(finalPanel);

    // Animación de entrada
    setTimeout(() => {
        finalPanel.style.right = "0";
    }, 50);
}

// Temporizador
let startTime;
let timerInterval;

function startTimer() {
    startTime = Date.now();
    timerInterval = setInterval(updateTimer, 1000);
}

function updateTimer() {
    const currentTime = Date.now();
    const elapsedTime = currentTime - startTime;

    const hours = Math.floor(elapsedTime / (1000 * 60 * 60));
    const minutes = Math.floor((elapsedTime % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((elapsedTime % (1000 * 60)) / 1000);

    const formattedTime = `${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
    document.getElementById("time").textContent = formattedTime;
}

function stopTimer() {
    clearInterval(timerInterval);
}

// Manejador de evento: validación automática con "input"
document.getElementById("answer-input").addEventListener("input", checkAnswer);

// Inicializar el marcador y temporizador al cargar la página
updateScoreDisplay(); // Inicializa la puntuación en 0/total
startTimer();

window.addEventListener("beforeunload", (event) => {
    if (score > 0) { // Mostrar advertencia solo si hay progreso
        event.preventDefault();
        event.returnValue = "¿Estás seguro de que quieres salir? Se perderá todo el progreso.";
    }
});
